<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>etcd server 启动 | oohcode | $\bigodot\bigodot^H \rightarrow CODE$</title>

  
  <meta name="author" content="sean chen">
  

  
  <meta name="description" content="入口文件入口:123456789// main.gopackage mainimport &quot;go.etcd.io/etcd/etcdmain&quot;func main() &amp;#123;    etcdmain.Main()&amp;#125;
开始启动过程
平台支持检查
启动参数解析
启动服务或者 proxy

">
  

  
  <meta name="keywords" content="sean">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="etcd server 启动">

  <meta property="og:site_name" content="oohcode">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="oohcode" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">oohcode</a>
    </h1>
    <p class="site-description">$\bigodot\bigodot^H \rightarrow CODE$</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/tags">标签</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>etcd server 启动</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/10/21/etcd-server-md/" rel="bookmark">
        <time class="entry-date published" datetime="2019-10-21T03:01:48.000Z">
          2019-10-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h1><p>文件入口:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"go.etcd.io/etcd/etcdmain"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    etcdmain.Main()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="开始启动过程"><a href="#开始启动过程" class="headerlink" title="开始启动过程"></a>开始启动过程</h2><ol>
<li>平台支持检查</li>
<li>启动参数解析</li>
<li>启动服务或者 proxy</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// etcdmain/main.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 检查支持的平台</span></span><br><span class="line">    checkSupportArch()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数解析</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">        cmd := os.Args[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> covArgs := os.Getenv(<span class="string">"ETCDCOV_ARGS"</span>); <span class="built_in">len</span>(covArgs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            args := strings.Split(os.Getenv(<span class="string">"ETCDCOV_ARGS"</span>), <span class="string">"\xe7\xcd"</span>)[<span class="number">1</span>:]</span><br><span class="line">            rootCmd.SetArgs(args)</span><br><span class="line">            cmd = <span class="string">"grpc-proxy"</span> <span class="comment">// 如果设置了 ETCDCOV_ARGS 环境变量，就是以 grpc-proxy 方式启动</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> cmd &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"gateway"</span>, <span class="string">"grpc-proxy"</span>: <span class="comment">// 如果设置了 cmd变量，就以变量的形式启动,包括 gateway, grpc-proxy 两种方式</span></span><br><span class="line">            <span class="keyword">if</span> err := rootCmd.Execute(); err != <span class="literal">nil</span> &#123; <span class="comment">// rootCmd.Execute 就等于调用 `etcd gateway` 或者 `etcd grpc-proxy`, 其它的参数不支持，调用的是 `etcd`</span></span><br><span class="line">                fmt.Fprint(os.Stderr, err)</span><br><span class="line">                os.Exit(<span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startEtcdOrProxyV2()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置检查-amp-启动-etcdServer"><a href="#配置检查-amp-启动-etcdServer" class="headerlink" title="配置检查 &amp; 启动 etcdServer"></a>配置检查 &amp; 启动 etcdServer</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// etcdmain/etcd.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startEtcdOrProxyV2</span><span class="params">()</span></span> &#123;</span><br><span class="line">    grpc.EnableTracing = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    cfg := newConfig()                             <span class="comment">// 默认配置项</span></span><br><span class="line">    defaultInitialCluster := cfg.ec.InitialCluster <span class="comment">// 对应配置文件中的 ETCD_INITIAL_CLUSTER 变量，默认的集群节点配置</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        logger := cfg.ec.GetLogger()</span><br><span class="line">        <span class="keyword">if</span> logger != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Sync()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新修改一下 cluster 配置中的 cluster 相关的信息，比如获取当前计算机的 hostname 代替 0.0.0.0 或 localhost</span></span><br><span class="line">    defaultHost, dhErr := (&amp;cfg.ec).UpdateDefaultClusterFromName(defaultInitialCluster)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stopped &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">var</span> errc &lt;-<span class="keyword">chan</span> error</span><br><span class="line"></span><br><span class="line">    which := identifyDataDirOrDie(cfg.ec.GetLogger(), cfg.ec.Dir) <span class="comment">// 检查存储数据的目录, 返回数据存储的类型是成员还是 proxy 等</span></span><br><span class="line">    <span class="keyword">if</span> which != dirEmpty &#123;                                        <span class="comment">// 节点目录不为空，证明不是第一次使用，恢复之前的配置</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">switch</span> which &#123;</span><br><span class="line">        <span class="keyword">case</span> dirMember: <span class="comment">// 如果是成员类型，需要开启一个 etcd 服务</span></span><br><span class="line">            stopped, errc, err = startEtcd(&amp;cfg.ec)</span><br><span class="line">        <span class="keyword">case</span> dirProxy: <span class="comment">// 如果是proxy, 则开启一个 proxy 服务</span></span><br><span class="line">            err = startProxy(cfg)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果为空，则根据参数启动服务</span></span><br><span class="line">        shouldProxy := cfg.isProxy()</span><br><span class="line">        <span class="keyword">if</span> !shouldProxy &#123; <span class="comment">// 如果不是 proxy, 则启动一个正常的 server</span></span><br><span class="line">            stopped, errc, err = startEtcd(&amp;cfg.ec)</span><br><span class="line">            <span class="keyword">if</span> derr, ok := err.(*etcdserver.DiscoveryError); ok &amp;&amp; derr.Err == v2discovery.ErrFullCluster &#123;</span><br><span class="line">                <span class="keyword">if</span> cfg.shouldFallbackToProxy() &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    shouldProxy = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> shouldProxy &#123; <span class="comment">// 如果是 proxy ,则启动一个 proxy 服务</span></span><br><span class="line">            err = startProxy(cfg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    osutil.HandleInterrupts(lg) <span class="comment">// 接收外界信号</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point, the initialization of etcd is done.</span></span><br><span class="line">    <span class="comment">// The listeners are listening on the TCP ports and ready</span></span><br><span class="line">    <span class="comment">// for accepting connections. The etcd instance should be</span></span><br><span class="line">    <span class="comment">// joined with the cluster and ready to serve incoming</span></span><br><span class="line">    <span class="comment">// connections.</span></span><br><span class="line">    notifySystemd(lg) <span class="comment">// 把型号发送给正在运行的 etcd 守护进程</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123; <span class="comment">// 进入阻塞状态，除非出现错误或者服务关闭</span></span><br><span class="line">    <span class="keyword">case</span> lerr := &lt;-errc:</span><br><span class="line">        <span class="comment">// fatal out on listener errors</span></span><br><span class="line">        <span class="keyword">if</span> lg != <span class="literal">nil</span> &#123;</span><br><span class="line">            lg.Fatal(<span class="string">"listener failed"</span>, zap.Error(lerr))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            plog.Fatal(lerr)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> &lt;-stopped:</span><br><span class="line">    &#125;</span><br><span class="line">    osutil.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// startEtcd runs StartEtcd in addition to hooks needed for standalone etcd.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startEtcd</span><span class="params">(cfg *embed.Config)</span> <span class="params">(&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, &lt;-<span class="keyword">chan</span> error, error)</span></span> &#123;</span><br><span class="line">    e, err := embed.StartEtcd(cfg) <span class="comment">// 根据配置开启一个 etcd server</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    osutil.RegisterInterruptHandler(e.Close) <span class="comment">// 注册通过信号关闭时的回调函数</span></span><br><span class="line">    <span class="keyword">select</span> &#123;                                 <span class="comment">// 进入阻塞,除非接收到下面的信号</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-e.Server.ReadyNotify(): <span class="comment">// wait for e.Server to join the cluster  阻塞，直到当前 server 注册到了集群中</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-e.Server.StopNotify(): <span class="comment">// publish aborted from 'ErrStopped' 注册失败</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e.Server.StopNotify(), e.Err(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="开启-peer-client-和-metrics-server"><a href="#开启-peer-client-和-metrics-server" class="headerlink" title="开启 peer , client 和 metrics server"></a>开启 peer , client 和 metrics server</h2><ol>
<li>etcd Server 启动会开起多个 server</li>
<li>peer server 用于 etcd 集群之间的选举，探活, 默认端口 2380</li>
<li>client 用于监听客户端请求，处理客户端读写, 默认端口 2379</li>
<li>metrics  用户监控集群状态，需要手动指定端口，否则不开启</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// embed/etcd.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// StartEtcd 回开启一个 etcd server, 并且接收 HTTP 请求，但是这个函数并不会保证加入到了集群中</span></span><br><span class="line"><span class="comment">// 加入集群是由  Etcd.Server.ReadyNotify() 来实现的</span></span><br><span class="line"><span class="comment">// StartEtcd launches the etcd server and HTTP handlers for client/server communication.</span></span><br><span class="line"><span class="comment">// The returned Etcd.Server is not guaranteed to have joined the cluster. Wait</span></span><br><span class="line"><span class="comment">// on the Etcd.Server.ReadyNotify() channel to know when it completes and is ready for use.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartEtcd</span><span class="params">(inCfg *Config)</span> <span class="params">(e *Etcd, err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err = inCfg.Validate(); err != <span class="literal">nil</span> &#123; <span class="comment">// 检查一些参数是否合法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    serving := <span class="literal">false</span></span><br><span class="line">    e = &amp;Etcd&#123;cfg: *inCfg, stopc: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)&#125;</span><br><span class="line">    cfg := &amp;e.cfg</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> e == <span class="literal">nil</span> || err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !serving &#123;</span><br><span class="line">            <span class="comment">// errored before starting gRPC server for serveCtx.serversC</span></span><br><span class="line">            <span class="keyword">for</span> _, sctx := <span class="keyword">range</span> e.sctxs &#123;</span><br><span class="line">                <span class="built_in">close</span>(sctx.serversC)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        e.Close()</span><br><span class="line">        e = <span class="literal">nil</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// 开启 peer server, 默认端口 2380</span></span><br><span class="line">    <span class="keyword">if</span> e.Peers, err = configurePeerListeners(cfg); err != <span class="literal">nil</span> &#123; <span class="comment">// 节点数据赋值</span></span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开启 client server,  默认端口 2379，并且支持多协议(grpc,http, https)</span></span><br><span class="line">    <span class="keyword">if</span> e.sctxs, err = configureClientListeners(cfg); err != <span class="literal">nil</span> &#123; <span class="comment">// client 数据赋值</span></span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, sctx := <span class="keyword">range</span> e.sctxs &#123; <span class="comment">// 当前 server ctx 记录</span></span><br><span class="line">        e.Clients = <span class="built_in">append</span>(e.Clients, sctx.l)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 token</span></span><br><span class="line">    memberInitialized := <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> !isMemberInitialized(cfg) &#123;</span><br><span class="line">        memberInitialized = <span class="literal">false</span></span><br><span class="line">        urlsmap, token, err = cfg.PeerURLsMapAndToken(<span class="string">"etcd"</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> e, fmt.Errorf(<span class="string">"error setting up initial cluster: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AutoCompactionRetention defaults to "0" if not set.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cfg.AutoCompactionRetention) == <span class="number">0</span> &#123;</span><br><span class="line">        cfg.AutoCompactionRetention = <span class="string">"0"</span></span><br><span class="line">    &#125;</span><br><span class="line">    autoCompactionRetention, err := parseCompactionRetention(cfg.AutoCompactionMode, cfg.AutoCompactionRetention)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    backendFreelistType := parseBackendFreelistType(cfg.ExperimentalBackendFreelistType)</span><br><span class="line">    <span class="comment">// 根据配置新建一个 server 对象</span></span><br><span class="line">    <span class="keyword">if</span> e.Server, err = etcdserver.NewServer(srvcfg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buffer channel 保证服务关闭的时候不会阻塞</span></span><br><span class="line">    <span class="comment">// buffer channel so goroutines on closed connections won't wait forever</span></span><br><span class="line">    e.errc = <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="built_in">len</span>(e.Peers)+<span class="built_in">len</span>(e.Clients)+<span class="number">2</span>*<span class="built_in">len</span>(e.sctxs))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// newly started member ("memberInitialized==false")</span></span><br><span class="line">    <span class="comment">// does not need corruption check</span></span><br><span class="line">    <span class="keyword">if</span> memberInitialized &#123;</span><br><span class="line">        <span class="keyword">if</span> err = e.Server.CheckInitialHashKV(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// set "EtcdServer" to nil, so that it does not block on "EtcdServer.Close()"</span></span><br><span class="line">            <span class="comment">// (nothing to close since rafthttp transports have not been started)</span></span><br><span class="line">            e.Server = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">return</span> e, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    e.Server.Start() <span class="comment">// 开启一个 etcd server</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 与每个 peer 保持通信</span></span><br><span class="line">    <span class="keyword">if</span> err = e.servePeers(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  开启 server 与每个 client 保持通信, 可以同时支持多重协议</span></span><br><span class="line">    <span class="keyword">if</span> err = e.serveClients(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 与每个 metrics 保持通信</span></span><br><span class="line">    <span class="keyword">if</span> err = e.serveMetrics(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> e, err</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    serving = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> e, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>e.Server.Start()</code>函数实现:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start performs any initialization of the Server necessary for it to</span></span><br><span class="line"><span class="comment">// begin serving requests. It must be called before Do or Process.</span></span><br><span class="line"><span class="comment">// Start must be non-blocking; any long-running server functionality</span></span><br><span class="line"><span class="comment">// should be implemented in goroutines.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *EtcdServer)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s.start()</span><br><span class="line">    <span class="comment">// 下面的函数将在 server 关闭后等执行完成</span></span><br><span class="line">    s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; s.adjustTicks() &#125;)</span><br><span class="line">    s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; s.publish(s.Cfg.ReqTimeout()) &#125;)</span><br><span class="line">    s.goAttach(s.purgeFile)</span><br><span class="line">    s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; monitorFileDescriptor(s.getLogger(), s.stopping) &#125;)</span><br><span class="line">    s.goAttach(s.monitorVersions)</span><br><span class="line">    s.goAttach(s.linearizableReadLoop)</span><br><span class="line">    s.goAttach(s.monitorKVHash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// start prepares and starts server in a new goroutine. It is no longer safe to</span></span><br><span class="line"><span class="comment">// modify a server's fields after it has been sent to Start.</span></span><br><span class="line"><span class="comment">// This function is just used for testing.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *EtcdServer)</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 通过一个 goroutine 开启服务</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> if this is an empty log, writes all peer infos</span></span><br><span class="line">    <span class="comment">// into the first entry</span></span><br><span class="line">    <span class="keyword">go</span> s.run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *EtcdServer)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    lg := s.getLogger()</span><br><span class="line">    sn, err := s.r.raftStorage.Snapshot()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// asynchronously accept apply packets, dispatch progress in-order</span></span><br><span class="line">    sched := schedule.NewFIFOScheduler()</span><br><span class="line">    ...</span><br><span class="line">    s.r.start(rh)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        s.wgMu.Lock() <span class="comment">// block concurrent waitgroup adds in goAttach while stopping</span></span><br><span class="line">        <span class="built_in">close</span>(s.stopping)</span><br><span class="line">        s.wgMu.Unlock()</span><br><span class="line">        s.cancel()</span><br><span class="line"></span><br><span class="line">        sched.Stop()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// wait for gouroutines before closing raft so wal stays open</span></span><br><span class="line">        s.wg.Wait()</span><br><span class="line"></span><br><span class="line">        s.SyncTicker.Stop()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// must stop raft after scheduler-- etcdserver can leak rafthttp pipelines</span></span><br><span class="line">        <span class="comment">// by adding a peer after raft stops the transport</span></span><br><span class="line">        s.r.stop()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// kv, lessor and backend can be nil if running without v3 enabled</span></span><br><span class="line">        <span class="comment">// or running unit tests.</span></span><br><span class="line">        <span class="keyword">if</span> s.lessor != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.lessor.Stop()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> s.kv != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.kv.Close()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> s.authStore != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.authStore.Close()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> s.be != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.be.Close()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> s.compactor != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.compactor.Stop()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(s.done)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">var</span> expiredLeaseC &lt;-<span class="keyword">chan</span> []*lease.Lease</span><br><span class="line">    <span class="keyword">if</span> s.lessor != <span class="literal">nil</span> &#123;</span><br><span class="line">        expiredLeaseC = s.lessor.ExpiredLeasesC()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> ap := &lt;-s.r.apply(): <span class="comment">// 数据更新</span></span><br><span class="line">            f := <span class="function"><span class="keyword">func</span><span class="params">(context.Context)</span></span> &#123; s.applyAll(&amp;ep, &amp;ap) &#125;</span><br><span class="line">            sched.Schedule(f)</span><br><span class="line">        <span class="keyword">case</span> leases := &lt;-expiredLeaseC: <span class="comment">// 租期过期处理</span></span><br><span class="line">            s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            ...</span><br><span class="line">             &#125;)</span><br><span class="line">        <span class="keyword">case</span> err := &lt;-s.errorc: <span class="comment">// 出现错误，退出 server</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-getSyncC(): <span class="comment">// 定期同步数据</span></span><br><span class="line">            <span class="keyword">if</span> s.v2store.HasTTLKeys() &#123;</span><br><span class="line">                s.sync(s.Cfg.ReqTimeout())</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> &lt;-s.stop: <span class="comment">// 停止信号，停止 server</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// etcdserver/raft.go.start</span></span><br><span class="line"><span class="comment">// raft node 启动，保持心跳</span></span><br><span class="line"><span class="comment">// start prepares and starts raftNode in a new goroutine. It is no longer safe</span></span><br><span class="line"><span class="comment">// to modify the fields after it has been started.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *raftNode)</span> <span class="title">start</span><span class="params">(rh *raftReadyHandler)</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多协议支持"><a href="#多协议支持" class="headerlink" title="多协议支持"></a>多协议支持</h2><p>如何做到监听一个端口, 开启多个协议的 server 进行处理呢？ 借助 <code>github.com/soheilhy/cmux</code> 来完成的。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Etcd)</span> <span class="title">serveClients</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !e.cfg.ClientTLSInfo.Empty() &#123;</span><br><span class="line">        <span class="keyword">if</span> e.cfg.logger != <span class="literal">nil</span> &#123;</span><br><span class="line">            e.cfg.logger.Info(</span><br><span class="line">                <span class="string">"starting with client TLS"</span>,</span><br><span class="line">                zap.String(<span class="string">"tls-info"</span>, fmt.Sprintf(<span class="string">"%+v"</span>, e.cfg.ClientTLSInfo)),</span><br><span class="line">                zap.Strings(<span class="string">"cipher-suites"</span>, e.cfg.CipherSuites),</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            plog.Infof(<span class="string">"ClientTLS: %s"</span>, e.cfg.ClientTLSInfo)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start a client server goroutine for each listen address</span></span><br><span class="line">    <span class="keyword">var</span> h http.Handler</span><br><span class="line">    <span class="keyword">if</span> e.Config().EnableV2 &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(e.Config().ExperimentalEnableV2V3) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            srv := v2v3.NewServer(e.cfg.logger, v3client.New(e.Server), e.cfg.ExperimentalEnableV2V3)</span><br><span class="line">            h = v2http.NewClientHandler(e.GetLogger(), srv, e.Server.Cfg.ReqTimeout())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            h = v2http.NewClientHandler(e.GetLogger(), e.Server, e.Server.Cfg.ReqTimeout())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mux := http.NewServeMux()</span><br><span class="line">        etcdhttp.HandleBasic(mux, e.Server)</span><br><span class="line">        h = mux</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gopts := []grpc.ServerOption&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> e.cfg.GRPCKeepAliveMinTime &gt; time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">        gopts = <span class="built_in">append</span>(gopts, grpc.KeepaliveEnforcementPolicy(keepalive.EnforcementPolicy&#123;</span><br><span class="line">            MinTime:             e.cfg.GRPCKeepAliveMinTime,</span><br><span class="line">            PermitWithoutStream: <span class="literal">false</span>,</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> e.cfg.GRPCKeepAliveInterval &gt; time.Duration(<span class="number">0</span>) &amp;&amp;</span><br><span class="line">        e.cfg.GRPCKeepAliveTimeout &gt; time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">        gopts = <span class="built_in">append</span>(gopts, grpc.KeepaliveParams(keepalive.ServerParameters&#123;</span><br><span class="line">            Time:    e.cfg.GRPCKeepAliveInterval,</span><br><span class="line">            Timeout: e.cfg.GRPCKeepAliveTimeout,</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// start client servers in each goroutine</span></span><br><span class="line">    <span class="keyword">for</span> _, sctx := <span class="keyword">range</span> e.sctxs &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(s *serveCtx)</span></span> &#123; <span class="comment">// 这里正式启动多个 client server， 包括不同的协议</span></span><br><span class="line">            e.errHandler(s.serve(e.Server, &amp;e.cfg.ClientTLSInfo, h, e.errHandler, gopts...))</span><br><span class="line">        &#125;(sctx)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面函数中 s.serve 函数的实现</span></span><br><span class="line"><span class="comment">// serve accepts incoming connections on the listener l,</span></span><br><span class="line"><span class="comment">// creating a new service goroutine for each. The service goroutines</span></span><br><span class="line"><span class="comment">// read requests and then call handler to reply to them.</span></span><br><span class="line"><span class="comment">// 这里使用了 github.com/soheilhy/cmux 来实现链接复用器</span></span><br><span class="line"><span class="comment">// 同一个链接可以根据其协议分发到不同的 server 协议处理</span></span><br><span class="line"><span class="comment">// 支持 grpc, ssh, http, https等</span></span><br><span class="line"><span class="comment">// 同一个链接依次只能是一个协议</span></span><br><span class="line"><span class="comment">// 根据协议头的前几个字段来判断协议</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sctx *serveCtx)</span> <span class="title">serve</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    s *etcdserver.EtcdServer,</span></span></span><br><span class="line"><span class="function"><span class="params">    tlsinfo *transport.TLSInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">    handler http.Handler,</span></span></span><br><span class="line"><span class="function"><span class="params">    errHandler <span class="keyword">func</span>(error)</span>,</span></span><br><span class="line"><span class="function">    <span class="title">gopts</span> ...<span class="title">grpc</span>.<span class="title">ServerOption</span>) <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    logger := defaultLog.New(ioutil.Discard, <span class="string">"etcdhttp"</span>, <span class="number">0</span>)</span><br><span class="line">    &lt;-s.ReadyNotify()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sctx.lg == <span class="literal">nil</span> &#123;</span><br><span class="line">        plog.Info(<span class="string">"ready to serve client requests"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m := cmux.New(sctx.l)</span><br><span class="line">    v3c := v3client.New(s)</span><br><span class="line">    servElection := v3election.NewElectionServer(v3c)</span><br><span class="line">    servLock := v3lock.NewLockServer(v3c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> gs *grpc.Server</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; gs != <span class="literal">nil</span> &#123;</span><br><span class="line">            gs.Stop()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// http 请求</span></span><br><span class="line">    <span class="keyword">if</span> sctx.insecure &#123;</span><br><span class="line">        gs = v3rpc.Server(s, <span class="literal">nil</span>, gopts...)</span><br><span class="line">        v3electionpb.RegisterElectionServer(gs, servElection)</span><br><span class="line">        v3lockpb.RegisterLockServer(gs, servLock)</span><br><span class="line">        <span class="keyword">if</span> sctx.serviceRegister != <span class="literal">nil</span> &#123;</span><br><span class="line">            sctx.serviceRegister(gs)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 匹配 HTTP2 协议</span></span><br><span class="line">        grpcl := m.Match(cmux.HTTP2())</span><br><span class="line">        <span class="comment">// 启动 grpc server</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; errHandler(gs.Serve(grpcl)) &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> gwmux *gw.ServeMux</span><br><span class="line">        <span class="keyword">if</span> s.Cfg.EnableGRPCGateway &#123;</span><br><span class="line">            gwmux, err = sctx.registerGateway([]grpc.DialOption&#123;grpc.WithInsecure()&#125;)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        httpmux := sctx.createMux(gwmux, handler)</span><br><span class="line"></span><br><span class="line">        srvhttp := &amp;http.Server&#123;</span><br><span class="line">            Handler:  createAccessController(sctx.lg, s, httpmux),</span><br><span class="line">            ErrorLog: logger, <span class="comment">// do not log user error</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 匹配 HTTP1 协议</span></span><br><span class="line">        httpl := m.Match(cmux.HTTP1())</span><br><span class="line">        <span class="comment">// 启动 client HTTP Server</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; errHandler(srvhttp.Serve(httpl)) &#125;()</span><br><span class="line">        sctx.serversC &lt;- &amp;servers&#123;grpc: gs, http: srvhttp&#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// https 请求</span></span><br><span class="line">    <span class="keyword">if</span> sctx.secure &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(sctx.serversC)</span><br><span class="line">    <span class="keyword">return</span> m.Serve()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/etcd-Go/">etcd Go</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    <br>
    
    &copy; 2019 sean chen
    
  </p>
</footer>
    
  </div>
</div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>